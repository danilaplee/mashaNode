(function(h,i,b){"use strict";var e=i.$,k=m,j=k.prototype,g="ivideon.utils.Application",a={}.toString;i.provide(g,k);k.ServiceInitError=i.utils.declareErrorClass(i.utils.CriticalError,g+".ServiceInitError");
k.DomainError=i.utils.declareErrorClass(i.utils.NonCriticalError,g+".DomainError");k.PackageLoadError=i.utils.declareErrorClass(i.utils.CriticalError,g+".PackageLoadError",["packageName","package"]);k.PackageNotFoundError=i.utils.declareErrorClass(i.utils.CriticalError,g+".PackageNotFoundError",["packageName"]);
function m(){var o=this;if(i.app){throw new i.utils.StateError(g+": Only one application instance is allowed.")}o._services=[];o._serviceIndexes={};o._packages={};o._unloadHandlers=[];o._unloadId=1;o._windowLoaded=false;
o._postMessages=[];var n=i.require({throwError:false},"ivideon.lang");if(n){n.addFunction("url",function(p,q){return o.createUrl(q[0],q[1])});n.addFunction("config",function(p,q){return i.require({root:i.app.getConfig(),prefix:"",throwError:false},q[0])||""
})}else{i.console.warn(g+": ivideon.lang is not available during app creation.")}o.events=new (i.require("ivideon.utils.Observable"))(o);e(h).on("message",o._onWindowMessageHandler=e.proxy(o._onWindowMessage,o));
e(h).one("load",function(){if(!o){return}o._windowLoaded=true;var p;while((p=o._postMessages.shift())){o._postMessageImpl.apply(o,p)}});e(h).one("unload",function(){if(!o){return}o.end();try{k._cleanupBrowserPlugins()
}catch(p){}o=null});o._setState(k.STATE_NEW)}k.STATE_NEW=1;k.STATE_CONFIG_INITIALIZING=2;k.STATE_CONFIG_INITIALIZED=3;k.STATE_SERVICES_INITIALIZING=4;k.STATE_SERVICES_INITIALIZED=5;k.STATE_DOM_INITIALIZING=6;
k.STATE_DOM_INITIALIZED=7;k.STATE_RUNNING=8;k.STATE_LOCKED=9;k.STATE_ENDING=10;k.STATE_ENDED=11;k._onDocumentTouchMove=function(n){if(e("body").outerHeight()<e(h).height()){n.preventDefault()}};k._cleanupBrowserPlugins=function(){e(h.document).find("object").each(i.utils.cleanupBrowserPlugins).end().find("embed").remove()
};j.init=function(n){var p=this,o=e.Deferred();i.console.log(g+"#init: ",n);p._initConfig(n).fail(function(q){o.reject(q)}).done(function(){p._initServices().fail(function(q){o.reject(q)}).done(function(){p._initDOM().fail(function(q){o.reject(q)
}).done(function(){p._setState(k.STATE_RUNNING);p.events.fire("initialized",null,true);o.resolve();i.console.log(g+"#init done: initialized "+h.location.href+" at "+i.now())})})});return o.promise()};j.getConfig=function(o,n){var p=this;
if(p._state===k.STATE_NEW||p._state===k.STATE_CONFIG_INITIALIZING){throw new i.utils.StateError(g+"#getConfig")}return(o?i.get(p._config,o,{instance:n,overwrite:false}):p._config)};j.createUrl=function(x,v,u){var s=this,o="/",q=/(^\/+)|(\/+$)/g,p=/(\/+$)/g,n=/^([a-z]+[a-z0-9\-]*\:)?\/\//i,w=/^(([a-z0-9_\-]+\/)?[a-z0-9_\-]+)?$/i,y,t,r;
if(typeof x!=="string"||!w.test(x)){throw new i.utils.ArgumentError(g+'#createUrl: Argument "route" is incorrect: '+x)}y=x.replace(/^main\//,"");if(typeof u==="undefined"||u===null){if(arguments.length>=3){throw new i.utils.ArgumentError(g+'#createUrl: Argument "baseUrl" is incorrect.')
}u=s.getConfig("app.rootUrl")}if(!n.test(u)){u=(u||"").replace(q,"");u=(u?o+u:"")}else{u=(u||"").replace(p,"")}y=(y||"").replace(q,"");y=(y?o+y:"");if(typeof v==="string"){r=v}else{if(v){t=v["#"];delete v["#"];
r="?"+e.param(v)+(t===""||t?"#"+t:"")}}r=(r?o+r:"");return(u+y+r)};j.getState=function(){var n=this;return n._state};j.isRunning=function(){var n=this;return(n._state===k.STATE_RUNNING)};j.isEnded=function(){var n=this;
return(n._state===k.STATE_ENDING||n._state===k.STATE_ENDED)};j.lock=function(){var n=this;if(n._state===k.STATE_LOCKED||n._state===k.STATE_ENDED){return}n._lockState=n._state;n._setState(k.STATE_LOCKED);
i.require("ivideon.utils.overlay")().done(function(o){if(n._state===k.STATE_LOCKED){o.$element.addClass("m-lock-overlay");n._lockOverlay=o}else{o.destroy();n._lockOverlay=null}});n.events.fire("locked")
};j.unlock=function(){var n=this;if(n._state!==k.STATE_LOCKED){return}n._setState(n._lockState);if(n._lockOverlay){n._lockOverlay.destroy();n._lockOverlay=null}n.events.fire("unlocked")};j.getTitle=function(){var p=this,o;
try{o=(h.document?h.document.title:b)}catch(n){}try{o=o||e("title").eq(0).html()}catch(n){}return(o||"")};j.setTitle=function(o){var p=this;if(p._state===k.STATE_ENDING||p._state===k.STATE_ENDED){return
}try{h.document.title=o}catch(n){i.reportError(n,{func:g+"#setTitle"})}};j.preventUnload=function(p,o){var r=this,n=r._unloadHandlers,q=r._unloadId++;if(n){n.push(q);n.push(p);n.push(o)}if(!r._onWindowBeforeUnloadHandler){e(h).on("beforeunload",r._onWindowBeforeUnloadHandler=e.proxy(r._onWindowBeforeUnload,r))
}return q};j.allowUnload=function(q){var s=this;var p,n,o=s._unloadHandlers,r;if(o){for(n=o.length,p=0;p<n;p+=3){r=o[p];if(r===q){o.splice(p,3);n-=3;p-=3}}}};j.postMessage=function(n,v,o){var p=this,t,r,s={func:g+"#postMessage"},u=e.Deferred();
if(typeof n==="string"&&e.inArray(n,["parent","self","top","opener"])<0){throw new i.utils.ArgumentError(s.func+': Argument "targetWindow" is not a Window or known string.')}if(!e.isPlainObject(v)){throw new i.utils.ArgumentError(s.func+': Argument "message" is not a plain Object.')
}o=o||"*";try{if(typeof v.timestamp==="undefined"){v.timestamp=i.now()}t=JSON.stringify(v)}catch(q){r=new i.utils.CriticalError(s.func+": Unable to stringify the message.");r.inner=q;i.reportError(r,s);
return u.reject(r).promise()}if(!p._windowLoaded){p._postMessages.push([n,t,o,u]);return u.promise()}return p._postMessageImpl(n,t,o,u)};j._postMessageImpl=function(q,x,r,y){var s=this,t="("+typeof q+")",w,p,v,u={func:g+"#_postMessageImpl"};
try{t=(typeof q==="string"?'"'+q+'"':a.apply(q))}catch(o){}try{if(typeof q==="string"&&e.inArray(q,["parent","self","top","opener"])>=0){w=h[q]}else{w=q}if(q!=="self"&&w===h){v=new i.utils.NonCriticalError(u.func+": Not posting because "+t+" equals to the current window.");
i.console.warn(v.message);return y.reject(v).promise()}}catch(n){p=n}if(!w||p){v=new i.utils.CriticalError(u.func+": Unable to resolve target window "+t+".");v.inner=p;i.reportError(v,u);return y.reject(v).promise()
}if(!w.postMessage){v=new i.utils.CriticalError(u.func+": Missing postMessage in target window "+t+".");i.reportError(v,u);return y.reject(v).promise()}try{w.postMessage(x,r)}catch(z){v=new i.utils.CriticalError(u.func+': Exception during postMessage call to "'+r+'" into '+t+".");
v.inner=z;i.reportError(v,u);return y.reject(v).promise()}i.console.log(u.func+': Posted to "'+r+'" into '+t+".",x);return y.resolve().promise()};j.registerService=function(s,q){var t=this,r,o,p;if(t._state===k.STATE_ENDING||t._state===k.STATE_ENDED){throw new i.utils.StateError(g+"#registerService")
}if(!s){throw new i.utils.ArgumentError(g+'#registerService: Argument "serviceId" not set.')}if(!q||(!e.isFunction(q)&&typeof q!=="object")){throw new i.utils.ArgumentError(g+'#registerService: Argument "options" is incorrect.')
}r=t._serviceIndexes[s];o=t._services[r];if(o){p=new i.utils.ArgumentError(g+'#registerService: Service "'+s+'" already registered.');i.set(p,"details.serviceIndex",r);i.set(p,"details.serviceDescriptor",o);
i.set(p,"details.services",t._services);throw p}o={id:s,options:q,instance:null};t._serviceIndexes[s]=t._services.length;t._services.push(o);i.console.log(s+"-service-registered",o);if(t._state===k.STATE_SERVICES_INITIALIZED||t._state===k.STATE_DOM_INITIALIZING||t._state===k.STATE_DOM_INITIALIZED||t._state===k.STATE_RUNNING||t._state===k.STATE_LOCKED){t._initService(o).fail(function n(u){i.reportError(u)
})}else{i.console.log(s+"-service-initializaion-queued",o)}};j.registerServices=function(n){var o=this;if(o._state===k.STATE_ENDING||o._state===k.STATE_ENDED){throw new i.utils.StateError(g+"#registerServices")
}e.each(n,function(q,p){var r=(typeof q==="number"?p.name:p.name||q);o.registerService(r,p)})};j.service=function(q){var r=this,p=r._serviceIndexes[q],n=r._services[p],o;if(n){if(n.instance){return n.instance
}o=new i.utils.CriticalError(g+'#service: Service "'+q+'" is registered but not initialized yet.');i.set(o,"details.serviceDescriptor",n)}else{o=new i.utils.CriticalError(g+'#service: Service "'+q+'" is not registered.')
}i.set(o,"details.serviceIndex",p);i.set(o,"details.services",r._services);throw o};j.hasService=function(o){var p=this,n=p._services[p._serviceIndexes[o]];if(n&&n.instance){return true}return false};j.loadPackage=function(n){var u=this,x=e.Deferred(),y=[],v,q,t=0,w=0,s,r;
if(u._state===k.STATE_ENDING||u._state===k.STATE_ENDED){throw new i.utils.StateError(g+"#loadPackage")}if(u._packages[n]===true){return x.resolve().promise()}function o(){if(t>=w){u._packages[n]=true;x.resolve();
return}var p=q.js[t++];i.loadjs(p,{crossOrigin:(/^(https?\:)?\/\//.test(p)?"anonymous":"use-credentials")}).done(o).fail(function(){x.reject(new k.PackageLoadError(g+'#loadPackage: Failed to load package "'+n+'" JS: '+p,n,q))
})}v=i.app.getConfig("packages");if(v&&v[n]){u._packages[n]=x;q=v[n];if(q.css){for(r=q.css.length,s=0;s<r;++s){y.push(i.loadcss(q.css[s]))}}if(q.js){w=q.js.length;t=0}e.when.apply(e,y).done(o).fail(function(){x.reject(new k.PackageLoadError(g+'#loadPackage: Failed to load package "'+n+'" CSS.',n,q))
});x.fail(function(){delete u._packages[n]})}else{x.reject(new k.PackageNotFoundError(g+'#loadPackage: Package "'+n+'" is not defined.',n))}return x.promise()};j.handleGoogleMapsLoaded=function(){var n=this;
n.events.fire("google-maps-loaded")};j.end=function(){var t=this,p,s,o,r,n;if(t._state===k.STATE_ENDING||t._state===k.STATE_ENDED){return}t._setState(k.STATE_ENDING);i.console.log(g+"#end: ending "+h.location.href+" at "+i.now());
t.events.fire("ending");t.lock();for(n=t._services.length,r=0;r<n;++r){p=t._services[r];s=p.id;o=p.instance;if(o){t.events.fire("service-destroying",s);try{if(typeof o.destroy==="function"){o.destroy()
}}catch(q){i.reportError(q,{func:g+"#end",part:"destroy_services",serviceId:s})}t.events.fire("service-destroyed",s)}t._services[r]=null;t._serviceIndexes[s]=-1;delete t[s]}t._serviceIndexes={};t._services=[];
if(t._onWindowBeforeUnloadHandler){e(h).off("beforeunload",t._onWindowBeforeUnloadHandler);t._onWindowBeforeUnloadHandler=null}t._unloadHandlers=[];if(t._onWindowMessageHandler){e(h).off("message",t._onWindowMessageHandler);
t._onWindowMessageHandler=null}e(h.document).off("touchmove",k._onDocumentTouchMove);t.events.forgetEvents("initialized");t.events.forgetEvents("dom-initialized");t.events.forgetEvents("services-initialized");
t.events.forgetEvents("config-initialized");t._setState(k.STATE_ENDED);i.console.log(g+"#end: ended "+h.location.href+" at "+i.now());t.events.fire("ended")};j._setState=function(n){var o=this;if(!n){throw new i.utils.ArgumentError(g+'#_setState: Argument "state" not set.')
}o._state=n};j._initConfig=function d(n){var t=this,o=e.Deferred(),p;t._setState(k.STATE_CONFIG_INITIALIZING);o.done(function r(){t._setState(k.STATE_CONFIG_INITIALIZED);t.events.fire("config-initialized",null,true)
}).fail(function q(u){i.reportError(u)});try{p=t._config=n||{};o.resolve()}catch(s){o.reject(s)}return o.promise()};j._initServices=function l(){var u=this,o=e.Deferred(),t=[],s,n;u._setState(k.STATE_SERVICES_INITIALIZING);
o.done(function r(){u._setState(k.STATE_SERVICES_INITIALIZED);u.events.fire("services-initialized",null,true)}).fail(function q(v){i.reportError(v)});try{for(n=u._services.length,s=0;s<n;++s){t[t.length]=u._initService(u._services[s])
}e.when.apply(e,t).done(e.proxy(o.resolve,o)).fail(e.proxy(o.reject,o))}catch(p){o.reject(p)}return o.promise()};j._initService=function c(p){var r=this,x=e.Deferred(),w=p.id,y=p.options,s,t,v,u,q,o;i.console.log(w+"-service-initializing",p);
try{if(e.isFunction(y)){s=y()}else{if(typeof y==="object"){if(y["class"]){t=y["class"];if(typeof t==="string"){t=i.require(t)}if(e.isFunction(t)){s=new (t)(y.config)}else{throw new i.utils.ArgumentError(g+'#_initService: Argument "options.class" is incorrect.')
}}else{if(e.isFunction(y.factory)){s=y.factory(y.config)}else{throw new i.utils.ArgumentError(g+'#_initService: Argument "options" is incorrect.')}}if(e.isArray(y.mixins)){for(o=y.mixins.length,q=0;q<o;
++q){v=y.mixins[q];if(typeof v==="string"){v=i.require(v)}if(e.isFunction(v)){v.call(s,y.config)}else{if(v){throw new i.utils.ArgumentError(g+'#_initService: Argument "options.mixins" is incorrect.')}}}}}else{throw new i.utils.ArgumentError(g+'#_initService: Argument "options" is incorrect.')
}}if(!s||(typeof s!=="object"&&typeof s!=="function")){throw new i.utils.ArgumentError(g+"#_initService: Service should be an object or a function.")}p.instance=s;p.options=null;r[w]=s;i.console.log(w+"-service-initialized",p);
x.resolve();r.events.fire("service-initialized",w,true);r.events.fire(w+"-service-initialized",null,true)}catch(n){u=new k.ServiceInitError(w);u.inner=n;i.console.error(w+"-service-initializaion-error",p,i.processError(u));
x.reject(u)}return x.promise()};j._initDOM=function f(){var q=this,n=e.Deferred();q._setState(k.STATE_DOM_INITIALIZING);n.done(function p(){q._setState(k.STATE_DOM_INITIALIZED);q.events.fire("dom-initialized",null,true)
}).fail(function o(r){i.reportError(r)});e(function(){try{var s=i.require({throwError:false},"ivideon.lang");if(!s){i.console.warn(g+"#_initDOM: ivideon.lang is not available on DOM ready.")}if(e.datepicker&&e.datepicker.setDefaults&&e.datepicker.regional){e.datepicker.setDefaults(e.datepicker.regional[(s?s.getMessage("ivideon.libs","jquery.ui.datepicker.lang")||"":"")])
}e(h.document).on("touchmove",k._onDocumentTouchMove);n.resolve()}catch(r){n.reject(r)}});return n.promise()};j._onWindowBeforeUnload=function(){var u=this;if(u._state===k.STATE_ENDING||u._state===k.STATE_ENDED){return
}var q,n,p=u._unloadHandlers,t,r,o,s;if(p){for(n=p.length,q=0;q<n;q+=3){t=p[q];r=p[q+1];o=p[q+2];if(typeof r==="function"){s=(o?r.call(o):r())}else{if(typeof r==="string"){s=r}}}if(typeof s!=="undefined"){return s
}}};j._onWindowMessage=function(r){var u=this,t=(r&&r.originalEvent&&r.originalEvent.data),o=(r&&r.originalEvent&&r.originalEvent.origin),s=(r&&r.originalEvent&&r.originalEvent.source),q,n={func:g+"#_onWindowMessage"};
if(u._state===k.STATE_ENDING||u._state===k.STATE_ENDED){return}if(t&&typeof t==="string"){try{q=JSON.parse(t)}catch(p){i.console.warn(n.func+': Unable to parse the incoming message from "'+o+'".',t);return
}i.console.log(n.func+': Received message from "'+o+'".',q);u.events.fire("window-message",{data:q,origin:o,source:s})}else{i.console.warn(n.func+': Received foreign message from "'+o+'".',t)}};i.app=new k()
}(window,window._ivideon));