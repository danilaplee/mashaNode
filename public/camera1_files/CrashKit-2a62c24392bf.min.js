/*!
 * Include this file to use CrashKit for reporting errors in your application.
 * Visit http://crashkitapp.appspot.com/ for details.
 *
 * Copyright (c) 2009 Andrey Tarantsov, YourSway LLC (http://crashkitapp.appspot.com/)
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * Huge thanks goes to Eric Wendelin, Luke Smith and Loic Dachary
 * for inspiring us and giving us a head-start in JS stack trace collection.
 * See: http://eriwen.com/javascript/js-stack-trace/
 *
 * Extended by John Babak <babak.john@gmail.com>.
 */
(function(c){var q=c.CrashKit={};q.getFunctionNameWithFallback=function(c){if(!c)return"";if(c.name)return c.name;c=c.toString()||"";var l=/function\s+([^(]*)\s*\(([^)]*)\)/.exec(c);return l=l&&l[1]?l[1]:c.replace(/[\s\r\n\t]+/g," ").replace(/^\s*function\s*/,"").replace(/[^A-Za-z0-9_$]+/g,"_").replace(/^_*([A-Za-z0-9_$]{1,100}[A-Za-z0-9$]+).*/,"$1")||"empty"};q.report=function(){var A=[],l=null,g=null,z=function(c){var f=null,l,g;l=A.length;for(g=0;g<l;++g)try{A[g](c)}catch(q){f=q}if(f)throw f;},
u=function(c,f,y,u,v){var x=null;g?(q.computeStackTrace.augmentStackTraceWithInitialElement(g,f,y,u),x=g,l=g=null):(v&&(x=q.computeStackTrace(v)),x&&"failed"!==x.mode&&"callers"!==x.mode?x.onerror={message:c,url:f,lineno:y,colno:u,error:v}:(f={url:f||null,line:y,column:u||null},f.func=q.computeStackTrace.guessFunctionName(f.url,f.line,f.column),f.context=q.computeStackTrace.gatherContext(f.url,f.line,f.column),x={mode:"onerror",name:"Error",message:c,stack:[f],stackstring:null},/Uncaught\s*([^:]+)\s*:\s*(.*)/.test(c)&&
(x.name=RegExp.$1,x.message=RegExp.$2)));z(x);return 0<A.length},v=function(u){if(g){if(l===u)return;var f=g;l=g=null;z(f)}var v=q.computeStackTrace(u,1);g=v;l=u;c.setTimeout(function(){l===u&&(l=g=null,z(v))},v.incomplete?500:1);throw u;};c._DEBUG||(c.onerror=u);v.subscribe=function(c){A.push(c)};return v}();q.computeStackTrace=function(){function A(){if("undefined"===typeof c.XMLHttpRequest){try{return new c.ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new c.ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(b){}try{return new c.ActiveXObject("Msxml2.XMLHTTP")}catch(h){}try{return new c.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}else try{return new c.XMLHttpRequest}catch(s){}throw Error("This browser does not support XMLHttpRequest.");
}var l={},g=function(a){if(!a||a.indexOf(".min.js")===a.length-7||!/(?:^https?\:\/\/)/i.test(a))return"";if(a.replace(/#.*$/,"")===c.location.href.replace(/#.*$/,""))return c.document.documentElement.innerHTML;try{var b=A();b.open("GET",a,!1);b.send("");return b.responseText}catch(h){return""}},z=function(a){var b;a in l||(b=g(a),l[a]=b?b.split("\n"):null);return l[a]},u=function(a,b,h){a:{a=z(a);if(b&&!(0>=b)&&a){h=/function\s+([^(]*)\s*\(([^)]*)\)/;var e=/['"]?([0-9A-Za-z$_]+)['"]?\s*[:=]\s*(function|eval|new Function)/,
s="",d;for(d=0;10>d;++d)if(s=a[b-d]+s,void 0!==s){var c=e.exec(s);if(c){b=c[1];break a}else c=h.exec(s);if(c&&c[1]){b=c[1];break a}}}b=""}return b},v=function(a,b,h){a=z(a);if(!b||0>=b||!a)return null;h=[];var e=!1,c;b-=1;for(c=b-2;c<=b+2;c++){var d=a[c];"undefined"!==typeof d&&d&&(e=!0);h.push(d)}return e?h:null},C=function(a){arguments.callee.sRE||(arguments.callee.sRE=RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g"));return a.replace(arguments.callee.sRE,"\\$1")},f=function(a){return C(a).replace("<",
"(?:<|&lt;)").replace(">","(?:>|&gt;)").replace("&","(?:&|&amp;)").replace('"','(?:"|&quot;)').replace(/\s+/g,"\\s+")},y=function(a,b,h){var e,c,d;e=b.length;for(h=0;h<e;++h)if(c=z(b[h]))if(c=c.join("\n"),d=a.exec(c))return a=c.substring(0,d.index).split("\n"),b={url:b[h],line:null,column:null},b.line=a.length,b.column=a[a.length-1].length,b;return null},E=function(a){var b=[c.location.href],h=c.document.getElementsByTagName("script"),e,s;a=""+a;var d=!1;for(e=0;e<h.length;e++)s=h[e],s.src&&b.push(s.src);
/^function(?:\s+([\w$]+))?\s*\(([\w\s,]+)\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/.test(a)?(e=(e=RegExp.$1)?"\\s+"+e:"",s=RegExp.$2,s=s.split(",").join("\\s*,\\s*"),h=RegExp.$3,d=1===h.split("\n").length,h=C(h).replace(/;$/,";?").replace(/\s+/g,"\\s+"),e=new RegExp("function"+e+"\\s*\\("+s+"\\)\\s*{\\s*"+h+"\\s*}")):e=new RegExp(C(a));if(d=y(e,b,d))return d;if(/^function on([\w$]+)\s*\(event\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/.test(a)){a=RegExp.$1;h=RegExp.$2;h=f(h);e=new RegExp("on"+a+"=[\\'\"]\\s*"+h+"\\s*[\\'\"]",
"i");if(d=y(e,b,!0))return d;e=new RegExp(h);if(d=y(e,b,!0))return d}return null},F=function(a,b){if(!a.stack)return null;var h=/^\s*$/,c=/^([^@]+?)@([a-z0-9-]+\:\/\/[^\/]+.*?)\:(\d+)(?:\:(\d+))?$/,s=a.name,d=a.stack,f=d.split("\n"),w=[],k,m,n;for(k=0;k<f.length;++k)if(m=f[k],!h.test(m))if(c.test(m))m=RegExp.$1,n=RegExp.$2,m={url:n,func:m,line:RegExp.$3?parseInt(RegExp.$3,10):null,column:RegExp.$4?parseInt(RegExp.$4,10):null},null===m.func&&m.line&&(m.func=u(m.url,m.line,m.column)),m.line&&(m.context=
v(m.url,m.line,m.column)),w.push(m);else return null;if(!w.length)return null;w.splice(0,b);return{mode:"safari",name:s+(a.type?" "+a.type:""),message:a.message,stack:w,stackstring:d,error:a,inner:a.inner}},x=function(a,b){if(!a.stack)return null;var h=/^(?:([^\s:]+)\:\s*)?.*$/i,c=/^\s*(eval )?at (?:((?:new )?[\s\S]+?(?: \[as [^\]]+\])?) )?[(]?(.+)[)]?\s*$/i,s=/^((?:native)|(?:unknown location)|(?:unknown source)|(?:<anonymous>))|(?:([a-z0-9-]+\:\/\/[^\/]+.*?)\:(\d+)(?:\:(\d+))?)|(eval at (.+))$/,
d=/^\[object Object\]\.crashkit_patched \[as (bind|ready|each)\]$/,f=/^.+\.(crashkit_wrapped)$/,w=/^([^.]+)\.\1_(.*)/,k=/^([^.]+\.([^\s]+))\s+\[as\s+\2\]/,m=/^\s*$/,n=a.name,p=a.stack,l=p.split("\n"),g=[],t,x=!0,q,r,y;for(t=0;t<l.length;++t)if(q=l[t],!m.test(q))if(x){if(!h.test(q))return null;x=!1;n=n||RegExp.$1}else if(c.test(q))r=RegExp.$2,y=RegExp.$3,q=!0,0===y.indexOf("eval ")&&(q=!1),d.test(r)?(r="crashkit_patched jQuery.fn."+RegExp.$1+"",q=!1):f.test(r)?(r=RegExp.$1,q=!1):(w.test(r)&&(r=RegExp.$1+
"."+RegExp.$2),k.test(r)&&(r=RegExp.$1)),s.test(y)&&(r={url:RegExp.$1?null:RegExp.$2||RegExp.$6,func:r,line:RegExp.$3?parseInt(RegExp.$3,10):null,column:RegExp.$4?parseInt(RegExp.$4,10):null},q&&(null===r.func&&r.line&&(r.func=u(r.url,r.line,r.column)),r.line&&(r.context=v(r.url,r.line,r.column))),g.push(r));else return null;if(!g.length)return null;g.splice(0,b);return{mode:"chrome",name:n+(a.type?" "+a.type:""),message:a.message,stack:g,stackstring:p,error:a,inner:a.inner}},G=function(a,b){if(!a.stack)return null;
var h=/^\s*(\w*)\s+(?:[a-z]+\s+)+(.*)$/i,c=/^\s*(?:([^(@]*)(?:\(.*\))?)?@(?:(.*?)\:(\d+)(?:\:(\d+))?)?\s*$/i,f=/^\s*$/,d=a.stack,q=d.split("\n"),w=[],k="firefox",m,n,p;n=q.length;for(m=0;m<n;++m)if(p=q[m],!f.test(p))if(h.test(p)&&(p=RegExp.$2,k="firefox-like"),c.test(p))p={url:RegExp.$2||null,func:RegExp.$1||"",line:RegExp.$3?parseInt(RegExp.$3,10):null,column:RegExp.$4?parseInt(RegExp.$4,10):null},!p.func&&p.line&&(p.func=u(p.url,p.line,p.column)),p.line&&(p.context=v(p.url,p.line,p.column)),w.push(p);
else return null;if(!w.length)return null;w.splice(0,b);return{mode:k,name:a.name,message:a.message,stack:w,stackstring:a.stacktrace||d,error:a,inner:a.inner}},H=function(a,b){var h=a.message,e=h.split("\n");if(4>e.length)return null;var s=/^\s*Line (\d+) of linked script ((?:file|http)\S+)(?:: in function (\S+))?\s*$/i,d=/^\s*Line (\d+) of inline#(\d+) script in ((?:file|http)\S+)(?:: in function (\S+))?\s*$/i,q=/^\s*Line (\d+) of function script\s*$/i,w=[],k=c.document.getElementsByTagName("script"),
m=[],n,p,l,g,t;p=k.length;for(n=0;n<p;++n)k[n].src||m.push(k[n]);n=2;for(p=e.length;n<p;n+=2){k=null;if(s.test(e[n]))k={url:RegExp.$2,func:RegExp.$3,line:RegExp.$1?parseInt(RegExp.$1,10):null,column:null};else if(d.test(e[n])){if(k={url:RegExp.$3,func:RegExp.$4,line:null,column:null},l=RegExp.$1-0,g=m[RegExp.$2-1])if(t=z(k.url))t=t.join("\n"),g=t.indexOf(g.innerText),0<=g&&(k.line=l+t.substring(0,g).split("\n").length)}else q.test(e[n])&&(l=c.location.href.replace(/#.*$/,""),t=new RegExp(f(e[n+1])),
(t=y(t,[l],!0))&&(k={url:l,func:"",line:t.line,column:t.column}));if(k)k.func||(k.func=u(k.url,k.line,k.column)),l=(t=v(k.url,k.line,k.column))?t[Math.floor(t.length/2)]:null,t&&l.replace(/^\s*/,"")===e[n+1].replace(/^\s*/,"")?k.context=t:k.context=[e[n+1]],w.push(k);else return null}if(!w.length)return null;w.splice(0,b);return{mode:"opera",name:a.name,message:e[0],stack:w,stackstring:h,error:a,inner:a.inner}},D=function(a,b,c,e){b={url:b,line:c,column:e};if(b.url&&b.line){a.incomplete=!1;b.func||
(b.func=u(b.url,b.line,b.column));b.context||(b.context=v(b.url,b.line,b.column));if(0<a.stack.length&&a.stack[0].url===b.url){if(a.stack[0].line===b.line&&("number"!==typeof b.column||"number"!==typeof a.stack[0].column||b.column===a.stack[0].column))return;if(!a.stack[0].line&&a.stack[0].func===b.func){a.stack[0].line=b.line;a.stack[0].column=b.column;a.stack[0].context=b.context;return}}a.stack.splice(0,0,b);return a.partial=!0}a.incomplete=!0},I=function(a,b){var c=[],e={},l=!1,d,f,g,k,m,n;for(d=
arguments.callee.caller;d&&!l;d){f=q.getFunctionNameWithFallback(d);g=E(d);n=m=k=null;g&&(k=g.url,m=g.line,n=g.column,f||(f=u(k,g.line,g.column)));0!==f.indexOf("crashkit_computeStackTrace")&&(l=!!e[d],e[d]=!0,f={url:k,func:f,line:m,column:n},l&&(f.recursion=!0),c.push(f));try{d=d.caller}catch(p){break}}c.splice(0,b);c={mode:"callers",name:a.name,message:a.message,stack:c,stackstring:a.stacktrace||a.stack||null,error:a,inner:a.inner};D(c,a.sourceURL||a.fileName||a.href||null,a.line||a.lineNumber||
null,a.column||a.columnNumber||a.colNumber||null);return c},B=function(a,b){var c=null;b="undefined"===typeof b?0:b-0;if("[object Array]"===Object.prototype.toString.call(a.stack))return{mode:a.mode,name:a.name,message:a.message,stack:a.stack,stackstring:a.stackstring,error:a,inner:a.inner};try{if(c=x(a,b))return c}catch(e){}try{if(c=F(a,b))return c}catch(f){}try{if(c=G(a,b))return c}catch(d){}try{if(c=H(a,b))return c}catch(g){}try{if(c=I(a,b))return c}catch(l){}return{mode:"failed",name:a.name,message:a.message,
stack:[],stackstring:a.stacktrace||a.stack||null,error:a,inner:a.inner}};B.augmentStackTraceWithInitialElement=D;B.guessFunctionName=u;B.gatherContext=v;B.ofCaller=function(a){a=("undefined"===typeof a?0:a-0)+1;try{0()}catch(b){return B(b,a)}};return B}()})(window);